<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Testing Your WP Plugins: A Practical Guide - Mihail Irintchev</title>

		<meta name="description" content="A quick guide to WordPress plugin testing">
		<meta name="author" content="Mihail Irintchev">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<!-- <link rel="stylesheet" href="css/theme/solarized.css" id="theme"> -->
		<link rel="stylesheet" href="css/theme/moon.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h2>Testing Your WP Plugins:</h2>
					<h3>A (Short) Practical Guide</h3>
					<p>
						<p>Created by Mihail Irintchev</p>
						<p><small>Head of Software Development @ SiteGround.com </small></p>
					</p>
					<p>
						<a mailto="m.irintchev@siteground.com">m.irintchev@siteground.com</a> / <a href="http://twitter.com/irintchev">@irintchev</a>
					</p>
				</section>

				<section>
					<h2>About me</h2>
					<ul>
						<li>From Sofia, Bulgaria</li>
						<li>Web developer since 2003</li>
						<li>Work @ SiteGround</li>
						<li>Organizer of <a href="https://twitter.com/bgphp">@bgphp</a> UG &amp; <br/><a href="http://bgphp.org">BulgariaPHP Conference</a></li>
						<li>Beer lover</li>
					</ul>
				</section>

				<section data-background="img/beer_styles_wide.jpg">
				</section>

				<section>
					<h2>Why test?</h2>
				</section>

				<section data-background="#333333">
					<img style="border: none" src="img/funny/tests-disturbing.jpg" />
				</section>

				<section>
					<h2>1. We are not perfect</h2>
					<img style="border: none" src="img/funny/king_leonidas_vitruvian_man.jpg" />
				</section>

				<section>
					<h2>2. Computers are great at automation</h2>
					<img style="border: none" src="img/funny/teamwork_hammering.gif" />
				</section>

				<section>
					<h2>3. Codex says so</h2>
					<blockquote cite="https://codex.wordpress.org/Writing_a_Plugin#Updating_Your_Plugin" style="text-align: left; width: 100%; font-size: 80%">
					When you're ready to release a new version of the Plugin... Make sure everything is committed and the new version <strong style="color: #773333">actually works</strong></strong>.
					</blockquote>

					<blockquote cite="https://codex.wordpress.org/Writing_a_Plugin#Updating_Your_Plugin" style="text-align: left; width: 100%; font-size: 80%">
					Pay attention to all WordPress versions your Plugin supports and try to test it with all of them. <strong  style="color: #773333">Don't just test the new features; also make sure you didn't accidentally break some older functionality of the Plugin</strong>.
					</blockquote>

					<span style=" font-size: 80%"><a href="https://codex.wordpress.org/Writing_a_Plugin#Updating_Your_Plugin">codex.wordpress.org/Writing_a_Plugin</a></span>

				</section>

				<section data-background="#333333">
					<img style="border: none" src="img/funny/untested_code.jpg" />
				</section>

				<section>
					<h2>The Tools</h2>
					<div>
						<div style="float: left; padding-left: 50px">
							<a href="http://phpunit.de"><img src="img/php-unit-logo.jpg" alt="PHPUnit" style="border: none; width: 400px" /></a><br/>
							<small>By <a href="http://sebastian-bergmann.de">Sebastian Bergmann</a></small>
						</div>
						<div style="float: right; padding-right: 50px">
							<a href="http://wp-cli.org/"><img src="img/wp-cli.jpg" alt="wp-cli" style="border: none" /></a><br/>
							<small>Maintained by <a href="https://github.com/danielbachhuber">Daniel Bachhuber</a></small>
						</div>
						<div style="clear: both"></div>
					</div>
					<aside class="notes">
						- Mention Sebastian Bergmann
					</aside>
				</section>

				<section>
					<h2>Prerequisites:</h2>
					<ul>
						<li>php 5.3+</li>
						<li>linux or mac OS (uses <code>/tmp</code>)</li>
						<li>mysql</li>
					</ul>
				</section>

				<section>
					<h2>Warning!</h2>
					<h3 style="padding-top:10px; color: #BB4444"><strong>DO NOT</strong> do this in production!</h3>
				</section>

				<section data-background="#333333">
					<img style="border: none" src="img/funny/i-dont-always-test-my-code.jpg" />
				</section>

				<section>
					<h2>Installation: PHPUnit</h2>
					<h4>linux:</h2>
					<pre><code data-trim class="bash">
wget http://phpunit.de/phpunit.phar
chmod +x phpunit.phar
sudo cp phpunit.phar /usr/local/bin/phpunit
					</code></pre>

					<h4>mac:</h2>
					<pre><code data-trim class="bash">
wget http://phpunit.de/phpunit.phar
chmod +x phpunit.phar
sudo cp phpunit.phar /usr/local/bin/phpunit
					</code></pre>
					<p>(Just follow instructions from <a href="http://phpunit.de">phpunit.de</a>)</p>
				</section>

				<section>
					<h2>Installation: wp-cli</h2>
					<pre><code data-trim class="bash">
wget https://raw.github.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
chmod +x wp-cli.phar
sudo cp wp-cli.phar /usr/local/bin/wp
					</code></pre>

					<h4>... then in your plugins dir:</h2>
					<pre><code data-trim class="bash">
wp scaffold plugin-tests yourplugin
./pluginname/bin/install-wp-tests.sh test_db_name db_user db_pass
					</code></pre>
					<p>(Just follow instructions from <a href="http://wp-cli.org/">wp-cli.org</a>)</p>
				</section>

				<section>
					<p style="font-size: 140%">What does <span style="color: #268BD2">wp-cli scaffold plugin-tests</span> basically do for you:</p>
					<ul>
						<li class="fragment">Creates a <code style="color: #268BD2">/tests</code> dir with sample test and tests bootstrap file</li>
						<li class="fragment">Creates a <code style="color: #268BD2">/bin</code> dir with <code style="color: #268BD2">install-wp-tests.sh</code> file</li>
						<li class="fragment">Creates a <code style="color: #268BD2">phpunit.xml</code> file to configure PHPUnit</li>
					</ul>
				</section>

				<section>
					<p style="font-size: 140%">What does <span style="color: #268BD2">bin/install-wp-tests.sh</span> do for you:</p>
					<ul>
						<li class="fragment">Downloads brand new WP and puts it in <code style="color: #268BD2">/tmp</code></li>
						<li class="fragment">Fires up a new WP instance using a test DB</li>
						<li class="fragment">Registers your plugin under test</li>
						<li class="fragment">Extends the phpunit TestCase class with extra fxn</li>
						<li class="fragment">Automatically set up/tear down test data</li>
					</ul>
				</section>

				<section>
					<h2>Things to test:</h2>
					<ul>
						<li class="fragment">any business logic/calculations</li>
						<li class="fragment">install / uninstall (like tables created/dropped)</li>
						<li class="fragment">activation / deactivation</li>
						<li class="fragment">custom post types present</li>
						<li class="fragment">custom post types meta stored</li>
						<li class="fragment">custom taxonomies and terms</li>
						<li class="fragment">external assets present and loaded</li>
						<li class="fragment">plugin headers/readme</li>
					</ul>
				</section>

				<section>
					<h2>How to create your tests</h2>
					<p>In <code>yourplugin/tests</code> directory there will be a file called <code>test-sample.php</code></p>
					<pre><code data-trim>
&lt;?php

class SampleTest extends WP_UnitTestCase {

	function test_sample() {
		// replace this with some actual testing code
		$this->assertTrue( true );
	}
}
					</code></pre>
					<p>Copy / rename that file and start implementing your tests there</p>
				</section>

				<section>
					<h2>Case study: Beerlog</h2>
					<img src="img/beerlog_plugins_list.png" />
				</section>

				<section>
					<h2>Beerlog: List beers</h2>
					<img src="img/beerlog_admin_list.png" />
				</section>

				<section>
					<h2>Beerlog: Edit beer</h2>
					<img src="img/beerlog_edit_beer.png" />
				</section>

				<section>
					<h2>Testing custom post type init</h2>
					<pre><code data-trim class="php" style="font-size: 18px; width: 950px; height: 100%">
&lt?php

class BeerlogInitTest extends WP_UnitTestCase
{
  public function test_beerPostTypeInit()
  {	
	// Assert beer post type set
	$postTypes = get_post_types( array( 'public' => true ), 'object' );
	$this->assertTrue( isset( $postTypes['beerlog_beer'] ) );

	$beerPostType = $postTypes['beerlog_beer'];

	// Assert some essential basic properties
	$this->assertTrue( $beerPostType->public );
	$this->assertTrue( $beerPostType->publicly_queryable );
	$this->assertTrue( $beerPostType->show_ui );
	$this->assertEquals( 'post', $beerPostType->capability_type );
	$this->assertFalse( $beerPostType->hierarchical );
	$this->assertTrue( in_array( 'beerlog_style', $beerPostType->taxonomies ) );

	// Assert Labels are set properly
	$expectedLabels = \Beerlog\Models\Beer::getPostTypeLabels();
	$actualLabels	= (array) $beerPostType->labels;
	foreach ( $expectedLabels as $label => $value ) {
	  $this->assertEquals( $value, $actualLabels[ $label ] );
	}

	// Assert basic properties are set properly
	$expectedProps = \Beerlog\Models\Beer::getPostTypeProperties();
	foreach ( $expectedProps as $propName => $value ) {
	  $this->assertEquals( $value, $beerPostType->$propName, $propName );
	}
  }

</code></pre>
				</section>

				<section>
					<h2>Testing custom taxonomy and terms</h2>
					<pre><code data-trim class="php" style="font-size: 18px; width: 950px; height: 100%">
public function test_beerStyleTaxonomyInit()
{
	// Assert beer style taxonomy registered
	$beerStyleTax = get_taxonomy( 'beerlog_style' );
	$this->assertTrue( is_object( $beerStyleTax ) );

	// Assert some essential basic properties
	$this->assertTrue( $beerStyleTax->hierarchical );
	$this->assertTrue( $beerStyleTax->public );
	$this->assertTrue( $beerStyleTax->show_ui );
	$this->assertTrue( $beerStyleTax->rewrite['hierarchical'] );
	$this->assertFalse( $beerStyleTax->rewrite['with_front'] );

	// Assert Labels are set properly
	$expectedLabels = \Beerlog\Utils\Init::convertArrayToI18n( \Beerlog\Utils\Init::$styleTaxLabels );
	$actualLabels	= (array) $beerStyleTax->labels;
	foreach ( $expectedLabels as $label => $value )
		$this->assertEquals( $value, $actualLabels[ $label ] );
}
					</code></pre>
				</section>

				<section>
					<h2>Testing custom post meta</h2>
					<p>The Magical <code>WP_UnitTestCase</code> Factory</p>
					<pre><code data-trim class="php" style="font-size: 18px; width: 950px; height: 100%">
public function test_renderBeerPostMeta()
{
	$beerId = $this->factory->post->create( array( 'post_type' => 'beerlog_beer' ) );
	$beerPost = get_post( $beerId );

	$expValues = array(
	  'abv' => rand( 2, 15 ),
	  'ibu' => rand( 8, 60 ),
	);
	// TODO: Add all the other meta props

	// Set some meta
	foreach ( $expValues as $metaName => $metaValue ) {
	  update_post_meta( $beerId, "_beerlog_meta_{$metaName}", $metaValue );
	}

	$controller = new \Beerlog\Controllers\Admin;

	ob_start();
	$controller->renderBeerPropertiesEdit( $beerPost );
	$metaHtml = ob_get_contents();
	ob_end_clean();

	// Assert all meta is present and field values correspond to stored meta data
	foreach ( $expValues as $metaName => $metaValue ) {
	  $escValue = preg_quote( $metaValue, '/' );
	  $this->assertTrue( (bool) preg_match( 
	    "/id=\"beerlog_meta_{$metaName}\"[^\/]+value=\"{$escValue}\"[^\/]*\/>/imU", $metaHtml 
	));
}
					</code></pre>
				</section>

				<section>
					<h2>Few words on OOP and Namespaces</h2>
					<ul>
						<li class="fragment">We do not want to create name-collisions</li>
						<li class="fragment">Encapsulation is one of the core principles of OOP</li>
						<li class="fragment">Namespaces introduce an additional level of isolation</li>
						<li class="fragment">Mocking is way easier</li>
					</ul>
				</section>

				<section>
					<h2>Cool stuff to to check out:</h2>
					<ul>
						<li>PHPUnit mocking functionality</li>
						<li>PHPUnit data providers</li>
						<li>Test-Driven Development (TDD)</li>
					</ul>
				</section>

				<section>
					<h2>Even more cool testing stuff</h2>
					
					<div>
						<div style="float: left; padding-left: 50px">
							<img src="img/phantomjs_qunit.png" alt="PhantomJS+QUnit" style="border: none" />
							<p><a href="https://qunitjs.com/">qUnit</a> JS Testing FW</p>
						</div>
						<div style="float: right; padding-right: 50px">
							<img style="border: none" src="img/seleniumhq.png" alt="seleniumhq" />
							<p><a href="http://www.seleniumhq.org/">Selenium HQ</a></p>
						</div>
						<div style="clear: both"></div>
					</div>

					<aside class="notes">
						<ul>
							<li> Explain about headless testing, the cool features of Qunit, </li>
							<li> mention Jordan Kasper and his "Browser Eyeballing != JavaScript Testing" talk </li>
						<ul>
					</aside>
				</section>

				<section>
					<h2>Credits &amp; references</h2>
					<p><a href="https://pantheon.io/blog/unit-testing-wordpress-plugins"><q>"Unit Testing WordPress Plugins"</q></a> by Cal Evans</p>
					<p><a href="http://phpqatools.org">The PHP Quality Assurance Toolchain</a></p>
					<p><a href="http://bit.ly/js-testing"><q>"Browser Eyeballing != JavaScript Testing"</q></a> by Jordan Kasper</p>
					<p>Slides: <a href="#">http://kyup.irintchev.com/loopconf</a></p>
				</section>

				<section data-background="img/pip/Questions.jpg">
					<div style="position: absolute; top: -100px; left: 50px">
						<h1 style="font-size: 2.3em; color: #268BD2">Thank You!</h1>
					</div>
					<div style="position: absolute; top: -190px; right: -40px; text-align: left">
						<a mailto="m.irintchev@siteground.com" style="color: #222">m.irintchev@siteground.com</a><br/>
						<a href="http://twitter.com/irintchev">@irintchev</a>
					</div>
				</section>

			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
